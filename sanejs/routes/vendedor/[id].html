<script server>
  const { get } = require('~/dist/data/vendedores.js');
  const { list } = require('~/dist/data/ventas.js');
  const {
    formatCurrency,
    formatDate,
    allSections,
  } = require('~/dist/utils.js');

  server.get(async (req, res) => {
    const { id } = req.params;
    const vendedor = await get(id);
    if (vendedor) {
      res.render(
        self,
        { vendedor, readonly: true, currentUser: req.session.currentUser },
        allSections
      );
    } else {
      res.showError(
        'No se encuentra ese vendedor',
        `El vendedor solicitado [${id}] no existe o ha sido borrado`,
        'info'
      );
    }
  });

  server.patch(async (req, res) => {
    const { id } = req.params;
    const { tab } = req.query;
    switch (tab) {
      case 'ventas':
        {
          const ventas = await list({ idVendedor: id });
          res.render(
            self,
            {
              currentUser: req.session.currentUser,
              details: { ventas: true },
              hide: { idVendedor: true },
              ventas: (ventas ?? []).map((v) => ({
                ...v,
                fecha: formatDate(v.fecha),
                precioUnitario: formatCurrency(v.precioUnitario),
                precioTotal: formatCurrency(
                  v.cantidad ?? 0 * v.precioUnitario ?? 0
                ),
              })),
              vendedor: { id },
            },
            'details'
          );
        }
        break;
      case 'consigna':
        res.render(
          self,
          {
            currentUser: req.session.currentUser,
            details: {
              consigna: true,
            },
            vendedor: { id },
          },
          'details'
        );
        break;
      default:
        res.render(self, { currentUser: req.session.currentUser }, 'details');
    }
  });
</script>

<title id="title">La Corazón - Vendedor: {= vendedor.nombre}</title>
<h1 id="heading">Detalle vendedor</h1>

<main id="main">
  {> vendedor/__form}
  <div id="details" class="wide">
    {? details.ventas}
    <details open hx-patch="/vendedores/ver/{= vendedor.id}" class="card">
      <summary class="card-header">Ventas</summary>
    </details>
    {> ventas/__table}
    <!-- prettier-ignore -->
    {: details.ventas}
    <details hx-patch="/vendedores/ver/{= vendedor.id}?tab=ventas" class="card">
      <summary class="card-header">Ventas</summary>
    </details>
    {/? details.ventas}
    <!-- prettier-ignore -->
    {? details.consigna}
    <details open hx-patch="/vendedores/ver/{= vendedor.id}" class="card">
      <summary class="card-header">Consigna</summary>
      <p class="card-body">Aquí va la consigna</p>
    </details>
    {: details.consigna}
    <details
      hx-patch="/vendedores/ver/{= vendedor.id}?tab=consigna"
      class="card"
    >
      <summary class="card-header">Consigna</summary>
    </details>
    {/? details.consigna}
  </div>
</main>
